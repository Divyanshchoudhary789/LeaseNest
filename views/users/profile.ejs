<% layout("/layouts/boilerplate") %>
    <% let firstLetter=currUser.username[0].toUpperCase(); let username=currUser.username; %>

        <link rel="stylesheet" href="/css/profile.css" />


        <div class="nav">
            <div class="left-nav">
                <div class="menu" id="menu"><i class="fa-solid fa-bars"></i></div>
                <a href="/listings"><i class="fa-solid fa-less-than"></i></a>
                <h4>Profile</h4>
            </div>
            <div class="right-nav" id="right-nav">
                <h4 class="bookings-btn active-btn" id="bookings-btn">Bookings</h4>
                <h4 class="reviews-btn" id="reviews-btn">Reviews</h4>
            </div>
            <div class="right-nav" id="right-nav-host">
                <h4 class="host-listings-btn active-btn" id="host-listings-btn">Listings</h4>
                <h4 class="host-bookings-btn" id="host-bookings-btn">Bookings</h4>
            </div>
        </div>

        <div class="body-div">
            <div class="profile-div mb-5" id="profile-div">
                <div class="arrow" id="arrow"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="profile-card">
                    <div class="icon">
                        <h2>
                            <%= firstLetter %>
                        </h2>
                    </div>
                    <h5>
                        <b>
                            <%= username %>
                        </b>
                    </h5>
                </div>
                <div class="host-panel-icon" id="host-panel"><i class="fa-solid fa-user-tie"></i>
                    <h4><b>Host Panel</b></h4>
                </div>

                <div class="user-panel-icon" id="user-panel"><i class="fa-solid fa-user"></i></i>
                    <h4><b>User Panel</b></h4>
                </div>
            </div>


            <div class="side-page mb-5" id="bookings-container">
                <div class="mb-3 mt-3">
                    <h4>Your Past Trips:</h4> &nbsp;&nbsp;<span>Stay Safe and Stay happy!</span>
                </div>

                <!-- Advanced Filter Section -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-bookings" placeholder="Search by listing or owner..." value="<%= typeof searchBookings !== 'undefined' ? searchBookings : '' %>">
                            <button class="clear-btn" id="clear-search-bookings" title="Clear search">&times;</button>
                        </div>
                        <div class="filter-controls">
                            <select id="sort-bookings" class="filter-select">
                                <option value="">Sort by Date</option>
                                <option value="recent" <%= sortBookings === 'recent' ? 'selected' : '' %>>Latest First</option>
                                <option value="old" <%= sortBookings === 'old' ? 'selected' : '' %>>Oldest First</option>
                            </select>
                            <select id="payment-status-bookings" class="filter-select">
                                <option value="all">All Payments</option>
                                <option value="paid" <%= paymentStatusBookings === 'paid' ? 'selected' : '' %>>Paid</option>
                                <option value="pending" <%= paymentStatusBookings === 'pending' ? 'selected' : '' %>>Pending</option>
                                <option value="failed" <%= paymentStatusBookings === 'failed' ? 'selected' : '' %>>Failed</option>
                                <option value="refunded" <%= paymentStatusBookings === 'refunded' ? 'selected' : '' %>>Refunded</option>
                            </select>
                        </div>
                    </div>
                </div>

                <% for(booking of bookings){ %>
                    <div class="card">
                        <div><img src="<%=booking.listing.image.url %>" class="booking-card-image"></div>
                        <div class="card-body">
                            <h5 class="card-text"><b>
                                    <%=booking.listing.title%>
                                </b></h5>
                            <h6>
                                <%=booking.listing.description%>
                            </h6>
                            <h6><b>Owned by:</b>
                                <%= booking.owner.username %>
                            </h6>
                            <h6>Price: <%= booking.listing.price%>&#8377; /month</h6>
                            <br>
                            <h6>Status: <b>
                                    <%= booking.status%>
                                </b></h6>
                            <h6><b>Guest: <%=booking.guest.username%> (You)</b></h6>
                            <h6>checkIn Date: <%= booking.checkIn.toLocaleString()%>
                            </h6>
                            <h6>checkOut Date: <%= booking.checkOut.toLocaleString()%>
                            </h6>
                            <h6>Booked on: <%=booking.bookedAt.toLocaleString() %>
                            </h6>
                            <h6><b>Payment Status: </b>
                                <%=booking.paymentStatus%>
                            </h6>
                            <br>
                            <h5>Total Rent: <%= booking.totalRent%>&#8377;</h5>
                            <% if(booking.status==="booked" && booking.checkIn> Date.now() ) { %>
                                <form method="post" action="/profile/booking/<%=booking._id%>/cancel?_method=PATCH">
                                    <button class="btn btn-dark"
                                        style="background-color: #fe424d; margin: 10px; border: none;">Cancel
                                        Booking</button>
                                </form>
                                <% } %>


                        </div>
                    </div>
                    <% } %>

            </div>

            <div class="review-container" id="review-container">
                <div class="mb-3 mt-3">
                    <h4>Reviews Posted by you:</h4>
                </div>

                <!-- Advanced Filter Section -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-reviews" placeholder="Search reviews..." value="<%= typeof searchReviews !== 'undefined' ? searchReviews : '' %>">
                            <button class="clear-btn" id="clear-search-reviews" title="Clear search">&times;</button>
                        </div>
                        <div class="filter-controls">
                            <select id="sort-reviews" class="filter-select">
                                <option value="">Sort by Date</option>
                                <option value="recent" <%= sortReviews === 'recent' ? 'selected' : '' %>>Latest First</option>
                                <option value="old" <%= sortReviews === 'old' ? 'selected' : '' %>>Oldest First</option>
                            </select>
                        </div>
                    </div>
                </div>

                <% for (review of reviews){ %>
                    <div class="review-card">
                        <span>
                            <h4><b>Comment:</b></h4>
                            <h6>
                                <%= review.comment %>
                            </h6>
                        </span>
                        <h5><b>Rating: </b>
                            <%=review.rating%> Stars
                        </h5>
                        <br>
                        <h5><b>Posted At:</b>
                            <%=review.createdAt.toLocaleString() %>
                        </h5>
                        <h5><b>by username:</b>
                            <%=review.author.username %>
                        </h5>
                        <h5><b>Email:</b>
                            <%=review.author.email %>
                        </h5>
                    </div>

                    <% } %>
            </div>

            <!-- Host Panel Data -->

            <div class="side-page mb-5" id="host-listings-container">
                <div class="mb-3 mt-3">
                    <h4>Your Posted Listings on LeaseNest:</h4>
                </div>

                <!-- Advanced Filter Section -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-listings" placeholder="Search by title or location..." value="<%= typeof searchListings !== 'undefined' ? searchListings : '' %>">
                            <button class="clear-btn" id="clear-search-listings" title="Clear search">&times;</button>
                        </div>
                        <div class="filter-controls">
                            <select id="sort-listings" class="filter-select">
                                <option value="">Sort by Date</option>
                                <option value="recent" <%= sortListings === 'recent' ? 'selected' : '' %>>Latest First</option>
                                <option value="old" <%= sortListings === 'old' ? 'selected' : '' %>>Oldest First</option>
                            </select>
                        </div>
                    </div>
                </div>

                <% for(listing of listingsForHost){ %>
                    <div class="listing-card mb-5">
                        <div><img src="<%=listing.image.url %>" class="booking-card-image"></div>
                        <div class="card-body">
                            <h5 class="card-text"><b>
                                    <%=listing.title%>
                                </b></h5>
                            <h6>
                                <%=listing.description%>
                            </h6>
                            <h6><b>Owned by:</b>
                                <%= listing.owner.username %>
                            </h6>
                            <h6>Price: <%=listing.price%>&#8377; /month</h6>
                            <h6>Location: <%=listing.location%>
                            </h6>
                            <h6>Listing Posted At: <%=listing.postedAt.toLocaleString()%></h6>
                            <br>
                            <h5><b>All Reviews:</b></h5>
                            <div class="reviews">
                                <% listing.reviews.forEach((review)=>{ %>
                                    <div class="review-card">
                                        <h5><b>Comment:</b>
                                            <%=review.comment%>
                                        </h5>
                                        <br>
                                        <h5><b>Rating:</b>
                                            <%=review.rating%>
                                        </h5>
                                        <br>
                                        <h5><b>Posted At:</b>
                                            <%=review.createdAt.toLocaleString()%>
                                        </h5>
                                        <h5><b>Posted by:</b>
                                            <%=review.author.username%>
                                        </h5>
                                    </div>
                                    <% }) %>

                            </div>
                            <form method="post" action="/listings/<%= listing._id %>?_method=DELETE">
                                <button class="btn btn-dark"
                                    style="background-color: #fe424d; margin: 10px; border: none;">Delete
                                    Listing</button>
                            </form>



                        </div>
                    </div>
                    <% } %>

            </div>



            <div class="side-page mb-5" id="host-bookings-container">
                <div class="mb-3 mt-3">
                    <h4>Your Listing Booking Details:</h4>
                </div>

                <!-- Advanced Filter Section -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-host-bookings" placeholder="Search by listing or guest..." value="<%= typeof searchHostBookings !== 'undefined' ? searchHostBookings : '' %>">
                            <button class="clear-btn" id="clear-search-host-bookings" title="Clear search">&times;</button>
                        </div>
                        <div class="filter-controls">
                            <select id="sort-host-bookings" class="filter-select">
                                <option value="">Sort by Date</option>
                                <option value="recent" <%= sortHostBookings === 'recent' ? 'selected' : '' %>>Latest First</option>
                                <option value="old" <%= sortHostBookings === 'old' ? 'selected' : '' %>>Oldest First</option>
                            </select>
                            <select id="payment-status-host-bookings" class="filter-select">
                                <option value="all">All Payments</option>
                                <option value="paid" <%= paymentStatusHostBookings === 'paid' ? 'selected' : '' %>>Paid</option>
                                <option value="pending" <%= paymentStatusHostBookings === 'pending' ? 'selected' : '' %>>Pending</option>
                                <option value="failed" <%= paymentStatusHostBookings === 'failed' ? 'selected' : '' %>>Failed</option>
                                <option value="refunded" <%= paymentStatusHostBookings === 'refunded' ? 'selected' : '' %>>Refunded</option>
                            </select>
                        </div>
                    </div>
                </div>

                <% for(booking of bookingsForHost){ %>
                    <div class="booking-card">
                        <div><img src="<%=booking.listing.image.url %>" class="booking-card-image"></div>
                        <div class="card-body">
                            <h5 class="card-text"><b>
                                    <%=booking.listing.title%>
                                </b>
                            </h5>
                            <h6><b>Owned by:</b>
                                <%= booking.owner.username %> (You)
                            </h6>
                            <h6>Price: <%= booking.listing.price%>&#8377; /month</h6>
                            <br>
                            <h6>Status: <b>
                                    <%= booking.status%>
                                </b></h6>
                            <h6>checkIn Date: <%= booking.checkIn.toLocaleString()%>
                            </h6>
                            <h6>checkOut Date: <%= booking.checkOut.toLocaleString()%>
                            </h6>
                            <h6>Booked At: <%=booking.bookedAt.toLocaleString() %>
                            </h6>
                            <br>
                            <h6>Guest: <b>
                                    <%=booking.guest.username%>
                                </b></h6>
                            <br>
                            <h5>Total Rent: <%= booking.totalRent%>&#8377;</h5>
                            <h5>Payment status: <%= booking.paymentStatus %>
                            </h5>

                        </div>
                    </div>
                    <% } %>

            </div>

        </div>


        <script src="/js/profile.js"></script>